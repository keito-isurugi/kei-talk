---
title: "【Go】わざとメモリリークするサンプルコードと検出方法"
emoji: ""
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: true
---

## 概要

- Go言語を使っていてメモリリークを経験したことがないので、意図的にメモリリークを発生させるサンプルコードを書いてみた
- メモリリークしているかも下記を使用して確認してみた
	- `pprof`（Goの標準profiler）
	- `go tool pprof` コマンドでメモリの使用状況を可視化

## サンプルコード


```go
package main

import (
	"fmt"
	"net/http"
	_ "net/http/pprof"
	"time"
)

// グローバル変数として巨大なスライスへの参照を保持
var leakedData = make([][]byte, 0)

func memoryLeak() {
	for {
		// 1MBのデータを作成
		data := make([]byte, 1024*1024)

		// グローバル変数にデータの参照を保持し続ける
		leakedData = append(leakedData, data)

		// 少し待つ
		time.Sleep(100 * time.Millisecond)
	}
}

func main() {
	// pprof用にHTTPサーバを起動（:6060でアクセス可能）
	go func() {
		fmt.Println(http.ListenAndServe("localhost:6060", nil))
	}()

	// メモリリークを発生させる関数を呼び出し
	memoryLeak()
}
```


## サンプルコード解説

- `net/http/pprof` をimportすることで、`http://localhost:6060/debug/pprof/` にアクセスできるようになる
- `memoryLeak()` 関数内で**1MBのデータを生成し続け、参照を** **`leakedData`** **に保持する**
- 本来なら使い終わったら開放されるべきだが、グローバル変数に参照が残ることでGCの対象にならずメモリを消費し続ける

## pprofで確認

1. ターミナルでサンプルコード実行
	1. `go run main.go`
2. 別ターミナルで下記コマンドの実行
	1. `go tool pprof http://localhost:6060/debug/pprof/heap`
3. `top`コマンド実行でメモリ食ってる関数を一覧表示
	1. ここで8.1MB全部が memoryLeak 関数内で確保され、解放されずに生き残ってるのがわかる

	```go
	(pprof) top
	Showing nodes accounting for 8.10MB, 100% of 8.10MB total
	      flat  flat%   sum%        cum   cum%
	    8.10MB   100%   100%     8.10MB   100%  main.memoryLeak (inline)
	         0     0%   100%     8.10MB   100%  main.main
	         0     0%   100%     8.10MB   100%  runtime.main
	```

4. `list 関数名` コマンドで行単位の詳細確認

	```go
	(pprof) list main.memoryLeak
	Total: 8.10MB
	ROUTINE ======================== main.memoryLeak in /Users/isurugikeito/dev/go/go-demo/demo/low_layer/main.go
	    8.10MB     8.10MB (flat, cum)   100% of Total
	         .          .     13:func memoryLeak() {
	         .          .     14:	for {
	         .          .     15:		// 1MBのデータを作成
	    8.10MB     8.10MB     16:		data := make([]byte, 1024*1024)
	         .          .     17:
	         .          .     18:		// グローバル変数にデータの参照を保持し続ける
	         .          .     19:		leakedData = append(leakedData, data)
	         .          .     20:
	         .          .     21:		// 少し待つ
	```

5. `web` コマンドでブラウザ上でグラフで視覚化
	1. 使用するにはGraphvizが必要(Macなら`brew install graphviz`でインストール)

	![%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-05-03_12.46.28.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/ec47a846-f108-4077-bbfc-3cc9cb452fc1/e479b551-2704-4494-8bfc-1be9a2770199/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-05-03_12.46.28.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4664XU4TKPZ%2F20250503%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250503T034808Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEEsaCXVzLXdlc3QtMiJIMEYCIQCq%2BQCjDzabUuDont5XvHBxkFcpWsV%2Bx1D04HZm2tAM5wIhAIGvMD8hr%2FErLpWosFseEW8zT1jvQHA%2B4ovNiecGO7qOKogECOT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igy90YCXLm9Kf07cwX8q3AP1VVdLChyzht%2FUfDBM5jOokiXq99fIAd6OlOuvS7Kdg%2BS%2B7%2FZHLtzS%2BbOt9tj7uYFw4fgRE2uA2dD6sFJ6NHVOSsG77%2FAmT%2BiE5QSfxqZa6wIiZEHxhrizHrOLx2OGWDqwe%2Fo5%2BW5XPGaNIrxB0oWWGDYfZIx3vDrKyJjcGe3VZXsV3E5DdqRvAIjEIsHToFIZx3rkayiNzzcMrU98bCf8Brva4MY41lRK0%2FuTj%2FjoMMcaNQ8SIydMbfPlX7Fz0PyCW0YdJB3O%2BS%2FYgv4H72cO1w5096GZOHFIaunul6UkiR15mzJ0aYa2v2xox2qKln0YjWumwOGftX66kmXdPnK4PPM0DOikjvWtGDzl2whgpKtJsL8bMics4NGpZ8mLxlGtbIQlHwOtfmASvu3vXEl7fz9%2BgX7HKULZ%2FNg0lgwduk%2FtgCIAL6cXIWe9ZjxT4yW%2FhHPzzz5%2Fy%2Fba%2B6lMZ0Rt%2FoUUMJhXh7IRnlJmorzg0eVXqI72L1zZ%2F0zfpMpttiQy%2B7tA3qQTsIKHdV2AtMUHmWz8MN1vvVY8fGJB4ETjnjb4TzGxzTVOX2GHXfFOkK4OFYNu8Tjr5nJfBASp8jyQ7VxzYVAJNDy5UGx1PwlGl1Zh7o3%2FI8v%2FPF6KIDDOhtbABjqkAZplnU0i91qH%2B3g3CFTtADWCLtuJGmQJoTh0cLdmHfXYwBVfWesr12YdawnJNdRhWuyE4Uyo2t5FjeTysPsrUXZ3TtfmRpZwGPMEwq0a0FfrLTso9w7ZExlUbRTgMEe%2F7iL2VyQjWE00mWwHTbREXdOfBgwp%2BP2WLzyEpfZ7NOnj4aQXpiI77k9WEp6FVmB7qidXBWaFpOIte7O4h06tC2uItW6M&X-Amz-Signature=f8779c68b93e2c980a382ddca97bd1457a13fa4d105050c6de9e4278ec283366&X-Amz-SignedHeaders=host&x-id=GetObject)

